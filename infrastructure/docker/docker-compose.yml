services:
  # ============================================
  # FRONTEND
  # ============================================
  librechat:
    image: ghcr.io/danny-avila/librechat-dev:latest
    container_name: librechat
    ports:
      - "3080:3080"
    env_file:
      - ../../.env
    depends_on:
      - mongodb
      - api
    volumes:
      - ./librechat.yaml:/app/librechat.yaml
      - ../../data/librechat:/app/client/public/images
      - /var/run/docker.sock:/var/run/docker.sock  # Enable docker exec for MCP
    environment:
      - HOST=0.0.0.0
      - MONGO_URI=mongodb://mongodb:27017/librechat
      - CONFIG_PATH=/app/librechat.yaml
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
    networks:
      - enterprise-chat
    restart: unless-stopped

  # ============================================
  # BACKEND SERVICES
  # ============================================
  
  # Main API Service (FastAPI + LLM + RAG)
  api:
    build:
      context: ../../apps/api
      dockerfile: Dockerfile
    container_name: enterprise-chat-api
    ports:
      - "8000:8000"
    env_file:
      - ../../.env
    volumes:
      - ../../apps/api/src:/app/src  # Hot reload in development
      - ../../apps/api/providers.yaml:/app/providers.yaml
    environment:
      # Database
      - MONGO_URI=mongodb://mongodb:27017/enterprise_chat
      - QDRANT_URL=http://qdrant:6333
      
      # LLM Services
      - OLLAMA_BASE_URL=http://ollama:11434
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      
      # App Config
      - ENVIRONMENT=development
      - LOG_LEVEL=INFO
      - API_V1_PREFIX=/api/v1
      
      # CORS
      - CORS_ORIGINS=http://localhost:3080,http://librechat:3080
      
      # Rate Limiting
      - RATE_LIMIT_ENABLED=true
      - RATE_LIMIT_REQUESTS=100
      - RATE_LIMIT_PERIOD=60
    depends_on:
      - mongodb
      - qdrant
      - ollama
    networks:
      - enterprise-chat
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # MCP Server - RAG Document Search (FastMCP with SSE)
  mcp-rag:
    build:
      context: ../../services/mcp-server
      dockerfile: Dockerfile
    image: mcp-rag-server:latest
    container_name: mcp-rag-server
    ports:
      - "5173:5173"  # FastMCP SSE endpoint
    environment:
      - API_BASE_URL=http://api:8000/api/v1
      - PORT=5173
    depends_on:
      - api
    networks:
      - enterprise-chat
    restart: unless-stopped
    command: python -m src.sse_server_v2

  # ============================================
  # DATA INFRASTRUCTURE
  # ============================================
  
  # MongoDB - Application & User Database
  mongodb:
    image: mongo:5
    container_name: mongodb
    hostname: mongodb
    ports:
      - "27017:27017"
    volumes:
      - ../../data/mongo:/data/db
    environment:
      - MONGO_INITDB_DATABASE=enterprise_chat
    networks:
      enterprise-chat:
        aliases:
          - mongodb
          - mongo
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Qdrant - Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"  # gRPC port
    volumes:
      - ../../data/qdrant:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    networks:
      - enterprise-chat
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Ollama - Local LLM & Embeddings
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ../../data/ollama:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    networks:
      - enterprise-chat
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # OPTIONAL SERVICES (Future Implementation)
  # ============================================
  
  # Redis - Caching & Rate Limiting
  # redis:
  #   image: redis:7-alpine
  #   container_name: redis
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - ../../data/redis:/data
  #   networks:
  #     - enterprise-chat
  #   restart: unless-stopped
  
  # PostgreSQL - Analytics & Logging
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: postgres
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - ../../data/postgres:/var/lib/postgresql/data
  #   environment:
  #     - POSTGRES_DB=enterprise_chat
  #     - POSTGRES_USER=admin
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
  #   networks:
  #     - enterprise-chat
  #   restart: unless-stopped

networks:
  enterprise-chat:
    driver: bridge
    name: enterprise-chat-network

volumes:
  mongo-data:
  qdrant-data:
  ollama-data:
